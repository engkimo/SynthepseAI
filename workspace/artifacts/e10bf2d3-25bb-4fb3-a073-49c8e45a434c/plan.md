# Plan for 2024年のプライム上場企業のデータ分析して可視化

- [pending] Task 1: 必要なPythonライブラリをインポートし、ロギング・警告・乱数種・日本語フォント設定（例: Noto Sans CJK）を初期化する。ImportError時は不足ライブラリ名を明示して終了する。 (id: 1f40bbe0-ca6a-4a4b-ad8f-83bbdbcc2656)
- [pending] Task 2: 分析設定値を定義する（対象年=2024、日付範囲、出力/キャッシュ/データのパス、リスクフリーレート、タイムゾーン=Asia/Tokyo、リトライ回数・タイムアウト、プロキシ、使用データソースURL、フォント名等）。環境変数（.env）からAPIキーやプロキシを読み込む。 (id: a2b2e69e-189a-4f13-b11b-1d3b4a52df45)
- [pending] Task 3: プロジェクトのディレクトリ構成を作成する（data/raw, data/processed, cache, outputs/figures, outputs/reports, logs）。既存の場合はスキップ。 (id: 08bad609-f51e-4809-9302-62295751f1b8)
- [pending] Task 4: JPX等の公開情報から2024年のプライム上場銘柄リスト（CSV/XLSX）をダウンロードする。既知の候補URLを順に試行し、HTTPエラー時は指数バックオフでリトライ。失敗時はキャッシュにある最新ファイルにフォールバック。 (id: df0f4b71-3bf2-4ae8-9338-d2eec3121823)
- [pending] Task 5: ダウンロードした原本ファイルの検証（サイズ>0、拡張子/フォーマット整合、開封可能性、簡易ハッシュ記録）。不正ファイルは破棄して再取得を促す。 (id: e9bdb854-4770-4379-8507-f8e2281bfd15)
- [pending] Task 6: 銘柄メタデータを読み込み、プライム市場のみ抽出。列名を標準化（証券コード、銘柄名、業種、上場市場、時価総額等）。証券コードをティッカー（例: 7203.T）に正規化し、日本語列のエンコーディング問題を処理する。 (id: d572590e-c797-455f-b7e9-0d9c1bdad336)
- [pending] Task 7: メタデータの品質検査（重複コード、欠損業種/名称、非数値コード、デリスティング/指定替え候補のフラグ）。不整合を修正または除外し、検査レポートをJSON/CSVで出力。 (id: d06304be-f4b7-43ff-aad8-4aaed258491e)
- [pending] Task 8: クリーニング済みの銘柄メタデータを永続化（CSVとParquet）し、解析で使用する最終リストを確定する。 (id: f804db97-f79f-4435-8f81-a00a3d9ca99f)
- [pending] Task 9: 2024年の日次株価データ（OHLCV、Adj Close）をyfinanceでバッチ取得。レート制限を考慮し、並列/分割バッチ＋リトライ。取得失敗銘柄の一覧を記録。 (id: ef4249d6-c87d-43d9-9631-320936d2295b)
- [pending] Task 10: yfinanceで取得できなかった銘柄に対し、pandas-datareader（Stooq等）でフォールバック取得を試行し、成功分を結合。依然取得不可の銘柄を最終的に除外リストに追加。 (id: 3a3d333e-eb61-429a-a154-e861f7ac8351)
- [pending] Task 11: 取得した原始株価データを銘柄ごとにキャッシュ（Parquet）へ保存し、再実行時のダウンロードを回避する。 (id: f3938591-69f4-48c2-b92f-5d3693f4b725)
- [pending] Task 12: 全銘柄の株価データをマルチインデックスDataFrame（日付×ティッカー）に正規化し、タイムゾーンをJSTに統一。2024年の取引日のみ（祝日・休日を考慮）にフィルタリングし、日付の完全性を検査。 (id: 5d6ace25-25b8-4407-9af9-18baea120d28)
- [pending] Task 13: 欠損値と外れ値の処理ルールを適用（小規模ギャップの前方/後方補間許容閾値、0出来高日の除外、スパイク検出とウィンズライジング）し、適用結果をフラグとして保持。 (id: 2c9fe650-5ddc-4dde-8f72-3291487e48ad)
- [pending] Task 14: 企業アクションの整合性を確認（Adj Closeを基準に分割・配当調整、異常なギャップの検出）。必要に応じてリターン計算をAdj Closeベースに固定。 (id: 93e19fa5-7a79-4c37-90b7-4459a1a2367f)
- [pending] Task 15: 各銘柄の指標を算出（営業日リターン、年初来累積リターン、年率ボラティリティ、最大ドローダウン、シャープレシオ：リスクフリーは設定値から）。 (id: 4327ea7a-5700-4b3d-9355-f2d5d5e1661c)
- [pending] Task 16: セクター別に指標を集計（等加重・時価総額加重の両方を計算、時価総額欠損は等加重にフォールバック）。セクターごとの日次シリーズと年次サマリーを作成。 (id: e26aeb4e-22b7-4b58-b22c-714522f28e14)
- [pending] Task 17: プライム市場の合成インデックスシリーズを構築（等加重・時価総額加重）。ベース値=100で2024年の時系列を算出し、指数の基本統計量を計算。 (id: d484d11b-b23b-42cc-82f4-8e2a1773669d)
- [pending] Task 18: 日次リターンの相関行列を計算し、階層的クラスタリングで並べ替えたヒートマップ用データを作成。相関の有意性検査（サンプル数チェック）を実施。 (id: ba3e8726-cdc4-4884-876d-ec0452194cef)
- [pending] Task 19: トップ/ワーストパフォーマー、ボラティリティ上位、最大ドローダウン上位、時価総額上位のランキングを抽出し、セクター別の代表銘柄を選定。 (id: 7f3557c7-c8f0-4f49-b15a-209aa02636a3)
- [pending] Task 20: 静的可視化を作成（指数推移、セクター別年初来騰落率バー、リターン分布ヒスト/カーネル密度、ボラ対リターン散布図、相関ヒートマップ）。日本語ラベルと桁・通貨表記を整える。 (id: d9b76243-6ac7-4086-824f-ee11cc698dc5)
- [pending] Task 21: インタラクティブ可視化を作成（Plotly: 銘柄/セクター切替可能な時系列、ツリーマップ/サンバーストでセクター×時価総額、ホバーに主要指標）。 (id: b4865997-3969-418e-8f39-583033a35cde)
- [pending] Task 22: 解析結果と可視化を保存（データはCSV/Parquet、図はPNG/SVG、インタラクティブはHTML）。ファイル名にタイムスタンプとハッシュを付与し、再現性を担保。 (id: 30b73aab-9845-4971-bd6b-b2cda3edb4f6)
- [pending] Task 23: サマリーレポートを自動生成（Markdown/HTML）。目的、データソース、フィルタ条件、主要KPI、図表、欠損・除外銘柄リスト、既知の制約を記載。 (id: 808eab86-4859-4024-93d7-61e9d3f63d02)
- [pending] Task 24: データ系メタデータ/マニフェストを生成（ソースURL、取得日時、ファイルハッシュ、件数、欠損率、処理ルール、バージョン）をmanifest.jsonとして保存。 (id: 0997d41b-7e34-47d2-99fa-fa6088f4faa4)
- [pending] Task 25: 主要処理のサニティチェックと簡易ユニットテストを実行（例: 価格の非負、営業日数レンジ、欠損率閾値、指標の範囲）。失敗時は詳細ログ出力。 (id: ba990a90-ea63-47f7-b4fb-72504f1e1ebf)
- [pending] Task 26: 再実行可能化のためのCLI/設定読込対応（argparse: 年度、出力パス、再取得フラグ、対象セクター等）。ヘルプメッセージと例を実装。 (id: 4f0ec019-24d9-4ec3-9ce0-33ddd56e549a)
