# 改善点と対応方針（提案）

本項では現状の失敗要因と改善提案を列挙します。優先度が高いものから順に記載します。

## 1. venv への依存導入が失敗する（致命）
- 症状: 生成されたタスクが繰り返し失敗。`core/project_environment.py` が固定パス `python3.13` へインストールを試みるため、実行環境と不一致になる。
- 対応: site-packages の実パスを動的検出し、そこへインストールするよう修正（仮想環境の Python 経由、もしくは `--target` 先を検出）。
- 受け入れ基準: Python 3.9–3.13 のいずれでも、venv にモジュールが導入され `import` が成功する。

## 2. OpenAI 既定モデルが旧式
- 症状: `gpt-4-turbo` 既定などの古い表記が残っている。
- 対応: 既定を `gpt-4o-mini` に更新。`config.json.example` / `.env.example` / README の記述整合性を確保。
- 受け入れ基準: 既定動作時に `gpt-4o-mini` が選択されること。

## 3. 依存解決の堅牢化
- 症状: venv の pip が見つからないケースや OS 差異で失敗。
- 対応: 優先順位を「venv の `python -m pip` → venv の pip → system python `--target` → shell の pip」に統一。`bs4 → beautifulsoup4` など既存の正規化は踏襲。
- 受け入れ基準: pip 実体の有無/パス差異に左右されず導入可能。

## 4. 無限失敗の予防
- 症状: 修復試行が続き、ユーザー視点で「終わらない」印象。
- 対応（提案）:
  - プラン全体のハードタイムアウト（例: 10–15分）を設け、超過時は要約と次アクション提案で終了。
  - タスクのハードタイムアウト（例: 実行120秒）を `execute_script` に導入（将来対応）。
  - バックグラウンドの持続思考スレッドは、プラン完了後のみ実行し、エラー時は起動しない。
- 受け入れ基準: 失敗時に有限回で収束し、明確な失敗レポートが得られる。

## 5. 生成コードの依存最小化（コスト/失敗率の低減）
- 症状: `pandas`/`numpy` 等の重量依存が頻出し、ネットワークやビルド依存で失敗しやすい。
- 対応（提案）:
  - プロンプト/テンプレートの方針を「標準ライブラリ優先・最小依存」へ調整。
  - データ処理は `csv`/`statistics`/`itertools`、描画は可能なら `matplotlib` ではなく CSV 出力までに留めるなど段階化。
- 受け入れ基準: ネットワーク遮断でも成功するタスク比率が向上。

## 6. オフライン/フォールバック運用の明確化
- 症状: モック/オフライン時の期待動作が分かりづらい。
- 対応（提案）: モック時は「結果要約/次のアクション」を返す簡易モードで完走し、依存導入を試みない設定フラグを追加（将来対応）。

## 7. テストと回帰防止
- 症状: 実行環境依存の退行が起きやすい。
- 対応（提案）: スモークテスト（venv作成→`requests`インストール→`import`）とテンプレート整合性テストを追加。

---

上記 1–2 は本コミットで修正済。3 は強化済。4–7 は今後の提案として docs に残し、イシュー化して進めてください。
