# 継続的思考AIによるスクリプト生成システムの強化

## 変更内容
- `multi_agent_discussion.py`の`DiscussionAgent.__init__()`メソッドに`provider`パラメータを追加し、OpenRouterとの互換性を確保
- 型インポートを`langchain.pydantic_v1`から`pydantic.v1`に修正
- `script_templates.py`に`integrate_task_results`関数を追加し、タスク実行結果を知識ベースに統合する機能を実装
- `enhanced_persistent_thinking_ai.py`に`integrate_task_results`メソッドを追加し、タスク実行結果の知識ベース統合を実装
- `get_knowledge_for_script`メソッドを拡張し、マルチエージェント討論の結果をより効果的に統合
- 知識グラフ属性へのアクセスエラーを修正
- `ScriptLinter`クラスを追加し、生成されたスクリプトの型インポート問題を自動修正
  - 外部ツール（isort、flake8、mypy）がインストールされていない場合でも基本的な型インポート修正が動作するよう改善
  - 行ごとの処理方式に変更し、不正なインポート文（`from typing import , Dict, Tuplefrom typing...`）が生成されないよう修正
- `ProjectEnvironment`クラスの`_format_python_code`メソッドを拡張し、`ScriptLinter`を統合
- **コード生成時にフォーマッターを適用**: `python_project_execute.py`の`_handle_execute_task`メソッドを修正し、テンプレート適用直後にフォーマッターを実行するよう変更
- **標準ライブラリの自動インポート**: 基本テンプレートに標準ライブラリ（`time`、`traceback`、`os`、`json`、`datetime`）を自動的にインポートするよう修正
- **エラーハンドリングの強化**: 例外処理時にトレースバック情報を出力するよう改善
- **PERSISTENT_THINKING_TEMPLATEの構造改善**: テンプレート構造を変更し、ネストされた関数定義による変数スコープ問題を解決
  - `{main_code}`をグローバルスコープに配置し、関数のネスト化を防止
  - `prepare_task()`関数と`main()`関数を分離し、タスク準備と実行を明確に分離
  - ユーザー定義コードが`run_task()`関数を定義することを想定した構造に変更
- **パッケージインストール前のPyPI存在確認**: パッケージをインストールする前にPyPIで存在確認を行う機能を追加
  - 存在しないパッケージ（例：`Yahoo`）のインストール試行を防止
  - 代替パッケージ（例：`Yahoo` → `yfinance`）を自動的に提案・インストール
  - 一般的な大文字小文字の間違い（例：`Pandas` → `pandas`）を自動修正

## 目的
この変更により、スクリプト生成システムと知識ベース（`thinking_log.jsonl`と`knowledge_db.json`）の間の双方向同期が強化されます。生成されたスクリプトは継続的思考で得られた知見を活用し、スクリプト実行結果は知識ベースに統合されて、システムが継続的に学習・改善する仕組みを実現します。

また、スクリプト生成時の型インポート問題（`Dict`を直接インポートするなど）を自動的に検出・修正する機能を追加し、より堅牢なスクリプト生成を実現します。フォーマッターをコード生成時に適用することで、実行前に型インポートの問題を確実に修正し、スクリプト実行エラーを防止します。

標準ライブラリの自動インポートとエラーハンドリングの強化により、生成されたスクリプトの実行時エラー（`time`や`traceback`モジュールが見つからないなど）を防止し、より堅牢なスクリプト実行を実現します。

テンプレート構造の改善により、ネストされた関数定義による変数スコープ問題を解決し、`time`や`traceback`モジュールが正しくインポートされ、すべてのスコープで利用可能になります。これにより、タスクスクリプトの実行エラーを大幅に削減し、システムの安定性を向上させます。

パッケージインストール前のPyPI存在確認機能により、存在しないパッケージ（例：`Yahoo`）のインストール試行を防止し、代わりに正しいパッケージ（例：`yfinance`）を使用するようにします。これにより、タスク実行の失敗を減らし、システムの安定性と効率性を向上させます。

## テスト方法
```bash
python main.py --goal "日本の株価平均のデータ分析タスクを実行して結果をグラフ化する"
```

## 関連情報
- 要求者: 遼介大堀 (ryosuke.ohori@ulusage.com)
- Link to Devin run: https://app.devin.ai/sessions/74e12ab64d7b4e69b03899550cbaf132
